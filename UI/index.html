<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>D3: Loading GeoJSON data and generating SVG paths</title>
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script src="https://d3js.org/d3-geo-projection.v2.min.js"></script>
    <script src="https://d3js.org/d3-collection.v1.min.js"></script>
    <script src="https://d3js.org/d3-dispatch.v1.min.js"></script>
    <script src="https://d3js.org/d3-dsv.v1.min.js"></script>
    <script src="https://d3js.org/d3-request.v1.min.js"></script>
    <script src="https://d3js.org/d3-queue.v3.min.js"></script>
    <script src="http://d3js.org/colorbrewer.v1.min.js"></script> 
    <script src="//code.jquery.com/jquery-1.10.2.js"></script>
</head>
<h3>
    <left>Oil Exports and Imports</left>
</h3>
<select id="inds">
        <option value="oil_production" selected="selected">Oil Production</option>
        <option value="oil_trade">Oil Trade</option>
</select>

<body>
    <script type="text/javascript">
        //Width and height
        var w = 1920;
        var h = 1024;

        //Define path generator, using the Albers USA projection
        var path = d3.geoPath()
            .projection(d3.geoCylindricalStereographic());
  
        // Develop a tooltip
        var tooltip = d3.select('body').append('div')
            .style('position', 'absolute')
            .style('background', 'white')
            .style('opacity', '0')
            .style('padding', '5,15px')
            .style('border', 'none');

        //Create SVG element
        var svg = d3.select("body")
            .append("svg")
            .attr("width", w)
            .attr("height", h);

        //Loading JSON files
        d3.queue()
            .defer(d3.json, "../Data/countries.json")
            .defer(d3.json, "../Data/oil_stats.json")
            .defer(d3.json,"../Data/inter_area.json")
            .await(ready);

        var countries, oil_stats, trade_movements;

        function ready(error, d1, d2,d3){
            if(error) throw(error);
            countries = d1;
            production_barrels = d2;
            trade_movements = d3;

            buildMap(countries, oil_stats, trade_movements);
        }

        function buildMap(countries, oil_stats, trade_movements){
            var features = countries.features;
            var vals = d3.values(production_barrels.year[2016]);

            color = d3.scaleThreshold()
                   .domain([1000, 2000, 3000, 4000, 5000, 14000])
                   .range(['#f0f9e8','#bae4bc','#7bccc4','#43a2ca','#0868ac', "#19198c"]);

            d3.select('#inds')
                .on("change", function () {console.log(this.value);});

            //Bind data and create one path per GeoJSON feature
            svg.selectAll("path")
                .data(features)
                .enter()
                .append("path")
                .attr('id', function(d) {
                    return d.properties.interarea_category
                })
                .attr("d", path)
                .attr('transform', 'scale(2)')
                .style("fill", function(d) {return fillMapData(d.properties.production_category,
                                                         production_barrels.year[2016])})
                .style("stroke", 'black')
                .on('mouseover', function(d) {return mapMouseOver(d.properties, production_barrels.year[2016])})
                .on('mouseout', function() {
                    tooltip.transition()
                        .style('opacity', 0);
                    d3.select(this)
                        .style('opacity', 1)
                })
                .on('click', function(d, i) { 
                     return clickMap(d.properties,trade_movements.year[2016])
                        }
                    )
                

                function fillMapData(production_category, production_barrels){
                    if (production_category == null){
                        return "white";
                    }
                    return color(production_barrels[production_category]);
                }

                function mapMouseOver(properties, production_barrels){
                    var production = 0;
                    if (properties.production_category != null){
                        production = production_barrels[properties.production_category];
                    }

                    var displayTip;
                    tooltip.transition()
                        .style('opacity', 1);

                    displayTip =  tooltip.html("Country: " + properties.name + "<br/>" + 
                                                "Oil Production: " +production)
                                    .style('left', (d3.event.pageX) + "px")
                                    .style('top', (d3.event.pageY) + "px");
                    return displayTip;
                }

                function clickMap(properties, trade_movements){
                    var movements = 0;
                    var imp, exp;
                    if(properties.interarea_category != null) {
                        imp = d3.keys(trade_movements[properties.interarea_category]['import']);
                        exp = d3.keys(trade_movements[properties.interarea_category]['export']);
                        
                        imp.forEach(function(id,i){
                            svg.selectAll('path[id="'+id+'"]')
                            .style('fill', 'darkorange')
                        });
                    } 
                }





        }
    </script>
</body>
</html>