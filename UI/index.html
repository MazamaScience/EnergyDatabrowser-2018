<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>D3: Loading GeoJSON data and generating SVG paths</title>
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script src="https://d3js.org/d3-geo-projection.v2.min.js"></script>
    <script src="https://d3js.org/d3-collection.v1.min.js"></script>
    <script src="https://d3js.org/d3-dispatch.v1.min.js"></script>
    <script src="https://d3js.org/d3-dsv.v1.min.js"></script>
    <script src="https://d3js.org/d3-request.v1.min.js"></script>
    <script src="https://d3js.org/d3-queue.v3.min.js"></script>
    <script src="http://d3js.org/colorbrewer.v1.min.js"></script> 
    <script src="//code.jquery.com/jquery-1.10.2.js"></script>

    <style>
    .dropdown{
        width: 115px;
        margin-left: 20px;
        float:left;
    }

    .slider{
        width: 300px;
        height: 15px;
        left-padding: 10px;
        float:left;

    }
    .slider:hover {
        opacity: 1;
    }
    .text{
        width: 150px;
        margin-left: 15px;
        float:left;
        font-weight:bold;
    }
    .clearfix
        {
            clear:both;
        }
    </style>
</head>
<h3>
    <left>World Oil Trade and Production Trends (2010-2016)</left>
</h3>

<select id="drop_down" class = "dropdown">
        <option value="oil_production">Oil Production</option>
        <option value="oil_trade" selected="selected">Oil Trade</option>
</select>

<div id = "text" class = "text">Years (2010-2016):</div>
<div id = "slider" class = slider>
  <input type="range" min="2010" max="2016" value = "2010" class="slider" id="Year">
</div>
<div id ="yeartext" class = "text">2010</div>
 <br/><br/>
<svg width="920" height="500"></svg>
<body>
    <script type="text/javascript">
    
        // Set default variable for year
        var years = ["2010","2016"]

        // Create scale for year Scale

        /*var yearScale = d3.scaleTime()
                           //.domain([new Date('1960'),new Date('1961'),new Date('1962'),new Date('1963'),new Date('1964'),new Date('1965')])
                           .domain([d3.min(years, function(d){return d}),d3.max(years, function(d){return d;})])
                           .range([0,1000]); 


        var yAxis = d3.axisBottom(yearScale)
                        //.tickFormat(d3.timeFormat('%Y'))
                        .ticks(7);
*/
        // Width and height
        // var width = 960;
        // var height = 500;

        //Define path generator, using projection
        var projection = d3.geoCylindricalStereographic()
                            .scale(150)
                            //.translate([960 / 2, 500 / 2]);
        var path = d3.geoPath()
            .projection(projection)
    
        // Develop a tooltip
        var tooltip = d3.select('body').append('div')
            .style('position', 'absolute')
            .style('background', 'white')
            .style('opacity', '0')
            .style('padding', '5,15px')
            .style('border', 'none');

        



        //Create SVG element
    /* var svg = d3.select("svg");
    margin = {top: 20, right: 20, bottom: 30, left: 50};
    width = +svg.attr("width") - margin.left - margin.right;
    height = +svg.attr("height") - margin.top - margin.bottom;
*/


var svg = d3.select("svg"),
    margin = {top: 20, right: 20, bottom: 30, left: 50},
    width = +svg.attr("width") - margin.left - margin.right,
    height = +svg.attr("height") - margin.top - margin.bottom;

    svg = svg.append("g")
                .attr("transform", "translate( 15 ," + margin.top + ")");

        

    /*
        svg = svg.append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")")
            .attr('style','float:left');
*/
        // add the scale
      /*  svg.append('g')
            .attr("transform","translate(10,10)")
            .call(yAxis)
*/
        //Loading JSON files
        d3.queue()
            .defer(d3.json, "../Data/countries.json")
            .defer(d3.json, "../Data/oil_stats.json")
            .defer(d3.json,"../Data/inter_area.json")
            .await(ready);

        var countries, oil_stats, trade_movements;

        function ready(error, d1, d2,d3){
            if(error) throw(error);
            countries = d1;
            oil_stats = d2;
            trade_movements = d3;

            buildMap(countries, oil_stats, trade_movements);
        }

        function buildMap(countries, oil_stats, trade_movements){
            var features = countries.features;

            constructEmptyMap(features);
            selected_type = d3.select('#drop_down').node().value;
            selected_year = 2016;

            //Make it dynamic according to input values
            color = d3.scaleThreshold()
                .domain([1000, 2000, 3000, 4000, 5000, 14000])
                .range(['#f0f9e8','#bae4bc','#7bccc4','#43a2ca','#0868ac', "#19198c"]);

            if(selected_type != 'oil_trade'){
                data = oil_stats[selected_type][selected_year];
                //Showing production values
                valueMap(features, data);
            }
            else{
                data = trade_movements[selected_year];
                //Showing trade area movements
                tradeMap(features, data);
            }

            d3.select('#Year').on("input", function(){displayyear();
                update();});
            d3.select('#drop_down').on("change", function(){update();});
                        

            function displayyear() {
                var yearSlider = document.getElementById("Year");
                year = yearSlider.value
                document.getElementById("yeartext").innerHTML = year;
            }



            function update(){
                var slider = document.getElementById("Year");
                selected_year = slider.value;

                var drop_down = document.getElementById("drop_down");
                selected_type = drop_down.value;

                if(selected_type != 'oil_trade'){
                    data = oil_stats[selected_type][selected_year];
                    svg.selectAll('path')
                        .on("click", '');
                    //Showing production values
                    valueMap(features, data);
                }
                else{
                    data = trade_movements[selected_year];
                    //Showing trade area movements
                    svg.selectAll('path')
                            .style('fill', 'white');
                    tradeMap(features, data);
                }
            }

            function constructEmptyMap(features){
                //Bind data and create one path per GeoJSON feature
                svg.selectAll("path")
                    .data(features)
                    .enter()
                    .append("path")
                    .attr('id', function(d) {return d.properties.interarea_category})
                    .attr("d", path)
                    //.attr('transform', 'scale(1.3)')
                    .style("fill", 'white')
                    .style("stroke", 'black')
            }

            function valueMap(features, data){
                svg.selectAll("path")
                    .data(features)
                    .transition()
                    .duration(500)
                    .style("fill", function(d){return fillMapData(d.properties.production_category, data)})

            }

            function fillMapData(production_category, oil_values){
                if (production_category == null){
                    return "white";
                }
                return color(oil_values[production_category]);
            }

            function tradeMap(features, data){
                svg.selectAll("path")
                    .data(features)
                    .on("click", function(d, i){return showTrade(d.properties.interarea_category, data)})
            }

            function showTrade(interarea_category, data){
                if (interarea_category != null){
                    data = data[interarea_category];
                    keys = d3.keys(data);

                    var tradeColor = d3.scaleLinear()
                                .domain([-100, -50, 0, 50, 100])
                                .range(["darkred", "red", "pink", "green", "darkgreen"]);

                    for (var i = 0; i < keys.length; i++){
                        imp = data[keys[i]]['imp'];
                        exp = data[keys[i]]['exp'];
                        net = imp - exp;
                        svg.selectAll('path[id="'+keys[i]+'"]')
                            .transition()
                            .duration(500)
                            .style('fill', tradeColor(net))
                    }
                }
            }

        }
    </script>
</body>
</html>